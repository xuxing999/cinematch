# 🚀 Realtime 修復執行指南

## 📝 問題總結

你在執行 `fix_realtime.sql` 時遇到語法錯誤（42601），因為 PostgreSQL 在 `ALTER PUBLICATION` 中不支援 `IF EXISTS` 語法。

## ✅ 解決方案

我已經重新生成了一個更穩健的 SQL 腳本：**`fix_realtime_v2.sql`**

此腳本使用 PL/pgSQL 的 `DO` 區塊來安全地處理：
- ✅ 檢查表格是否已在 publication 中
- ✅ 只在需要時才執行 ADD TABLE
- ✅ 安全地創建或更新 RLS 政策
- ✅ 設定 Replica Identity 為 FULL
- ✅ 提供完整的診斷資訊

---

## 🛠️ 立即執行（3 步驟）

### **步驟 1：執行新的 SQL 腳本**

1. 前往你的 Supabase Dashboard：
   ```
   https://app.supabase.com/project/wphhfdfrqqbgzumohdxj
   ```

2. 點選左側選單的 **SQL Editor**

3. 點選 **New Query** 建立新查詢

4. 開啟專案根目錄的 `fix_realtime_v2.sql` 檔案

5. 將整個檔案內容複製貼上到 SQL Editor

6. 點選 **Run** 執行

7. **檢查執行結果：**
   - 應該會看到 ✅ 和 ℹ️ 的 NOTICE 訊息
   - 最後會顯示診斷表格
   - 確認 `in_publication` 欄位顯示 **`true`** ✅
   - 確認 `replica_identity` 欄位顯示 **`f`** (代表 FULL) ✅

---

### **步驟 2：確認 Replication 設定**

1. 在 Supabase Dashboard，前往 **Database** → **Replication**

2. 找到 **`messages`** 表格，確認：
   - ✅ `supabase_realtime` 有勾選
   - ✅ Realtime 開關是 **ON**

3. 找到 **`signals`** 表格，做同樣的確認

4. 如果有任何變更，點選 **Save**

---

### **步驟 3：測試 Realtime 功能**

1. **重新啟動開發伺服器：**
   ```bash
   # 在終端機按 Ctrl+C 停止伺服器

   # 清除快取
   rm -rf .next

   # 重新啟動
   npm run dev
   ```

2. **前往測試頁面：**
   ```
   http://localhost:3000/test-realtime
   ```

3. **檢查連線狀態：**
   - ✅ 應該顯示 **`SUBSCRIBED`**（綠色圓點）
   - ✅ 日誌中顯示「✅ 訂閱成功！Realtime 功能正常運作！」

4. **測試即時訊息：**
   - 開啟**無痕視窗**（或另一個瀏覽器）
   - 登入並發送訊息
   - 回到測試頁面
   - ✅ 應該立即看到 📨 INSERT 事件

---

## 🎯 預期結果

執行 SQL 後，你應該會看到：

```
✅ messages 表已加入 supabase_realtime publication
✅ signals 表已加入 supabase_realtime publication
✅ Realtime 專用 RLS 政策已創建

診斷結果：
table_name | rls_policies_count | in_publication | replica_identity | status
-----------+--------------------+----------------+------------------+---------------
messages   | 3                  | true           | f                | ✅ 設定完整
signals    | 4                  | true           | f                | ✅ 設定完整
```

---

## 📊 測試頁面的新功能

我已經升級了測試頁面（`/test-realtime`），現在會顯示：

1. **詳細的連線資訊**：
   - Supabase URL
   - Channel 名稱
   - 監聽的表格和事件

2. **即時統計**：
   - 收到的 INSERT 事件數量
   - 收到的 UPDATE 事件數量

3. **更詳細的錯誤訊息**：
   - 如果訂閱失敗，會顯示完整的錯誤詳情
   - 提供明確的故障排除步驟

4. **成功指標清單**：
   - 讓你清楚知道什麼是正常運作的狀態

---

## 🔍 故障排除

### **問題 1：執行 SQL 時出現權限錯誤**

**解決方案：**
- 確認你使用的是 Supabase 專案擁有者帳號
- 或確認你的帳號有 `CREATE POLICY` 權限

### **問題 2：診斷結果顯示 `in_publication = false`**

**解決方案：**
1. 手動執行：
   ```sql
   ALTER PUBLICATION supabase_realtime ADD TABLE public.messages;
   ALTER PUBLICATION supabase_realtime ADD TABLE public.signals;
   ```
2. 重新整理 Dashboard
3. 重新執行診斷查詢

### **問題 3：測試頁面顯示 `CHANNEL_ERROR`**

**解決方案：**
1. 確認 SQL 已成功執行
2. 檢查 Database → Replication 設定
3. 完全重新整理瀏覽器（Cmd+Shift+R）
4. 檢查瀏覽器 Console（F12）的錯誤訊息

### **問題 4：狀態是 `SUBSCRIBED` 但收不到訊息**

**可能原因：**
- RLS 政策阻擋了訊息
- 你發送的訊息不符合過濾條件（例如：24小時限制）

**解決方案：**
1. 在 SQL Editor 執行：
   ```sql
   SELECT * FROM realtime_diagnostic;
   ```
2. 確認 `rls_policies_count` >= 2
3. 檢查訊息的 `created_at` 是否在 24 小時內

---

## 📂 生成的檔案

我已經在專案根目錄建立了以下檔案：

1. ✅ **`fix_realtime_v2.sql`**
   - 穩健的 SQL 修復腳本
   - 使用 DO 區塊安全處理
   - 包含完整的診斷查詢

2. ✅ **`執行指南.md`**（本檔案）
   - 簡潔的執行步驟
   - 故障排除指南

3. ✅ **`REALTIME_FIX_GUIDE_zh-TW.md`**
   - 詳細的技術說明
   - 深入的故障排除

4. ✅ 升級後的 **`app/test-realtime/page.tsx`**
   - 更詳細的連線資訊
   - 即時統計功能
   - 改進的錯誤處理

---

## ✅ 完成檢查清單

執行後，請確認：

- [ ] SQL 執行成功，沒有錯誤訊息
- [ ] 診斷結果中 `in_publication = true`
- [ ] 診斷結果中 `replica_identity = f`
- [ ] Database → Replication 中 messages 和 signals 的 Realtime 是 ON
- [ ] 測試頁面顯示 `SUBSCRIBED` 狀態
- [ ] 發送訊息後立即看到 INSERT 事件
- [ ] 統計數字會即時增加
- [ ] 導航列的紅色氣泡會出現

---

## 🆘 需要幫助？

如果完成所有步驟後仍然無法運作，請提供：

1. **SQL 執行結果**（截圖或複製文字）
2. **診斷查詢的結果**：
   ```sql
   SELECT * FROM realtime_diagnostic;
   ```
3. **測試頁面的狀態**（截圖）
4. **瀏覽器 Console 的輸出**（F12）

我會根據這些資訊進一步協助你！🚀
